<!--- WGG
<cfinclude template = "../cf_includes/cf_PRE_template_include.htm">
<cfparam name = "display_mode" default = "">
<!--- set form and list files --->
<cfset form_name="data_issue_report.htm">
<cfset list_file="data_issue_report.htm">
<!--- page title --->
<cfset page_title="Data Issue Report">
<!--- page header --->
<cfinclude template = "../templates/header.htm">
WGG --->

<!--- WGG 5/27/2014 this is if you are passing in variables
  everything which is being chosen on the report like
  dates or broker id --->
<cfset default_query_name = "">
<cfset default_variables = "
  member_id
  k_data_source
  form_ticket_status
  form_ticket_ignored
  form_broker_name
  form_mem_id
  form_ticket_resolved
  ">
<!--- WGG 5/27/2014 the below line makes the cfset default_variables work --->
<cfinclude template="../cf_includes/set_defaults.htm">

<cf set cid = #q_pop_blank_line_item.cid#>

<!--- WGG 6/21/2014 looks for blank line items for effectives in last 3 months--->
<cfquery name="q_pop_blank_line_item" datasource="#application.sys_ds#">
  INSERT INTO TAG_data_issues
    (cid
    ,k_tag_issue_type
    ,k_tag_issue_reason
    ,is_ignored
    ,date_opened
    ,is_resolved
    ,k_brk_broker
    ,k_mem_member_master
    ,k_mem_membership_window
    ,k_brk_entity_contract
    ,k_tag_issue_status_id)
  SELECT
     w.cid -- cid
    ,1 -- issues type: missing line item
    ,1 -- reason not known
    ,0 -- not ignored
    ,GETDATE() -- date opened
    ,0 -- is resolved
    ,w.k_brk_broker
    ,w.k_mem_member_master
    ,w.pk_mem_membership_window
    ,w.k_brk_entity_contract
    ,0 -- issue status is needs review
  FROM mem_membership_window w
    LEFT JOIN TAG_data_issues
      ON TAG_data_issues.k_mem_membership_window = w.pk_mem_membership_window
      AND TAG_data_issues.k_tag_issue_type = 1
    LEFT JOIN brk_broker b
      ON w.k_brk_broker = b.pk_brk_broker
    
  WHERE 1=1
    /* do not insert missing line item issues already in data issue table */
    AND TAG_data_issues.pk_TAG_data_issues IS NULL
    /* client is Molina */
    AND w.cid = <cfqueryparam value="#cid#" cfsqltype="cf_sql_integer">
    /* Line item is not assigned */
    AND w.K_BRK_entity_contract_line_item is NULL
    /* Window start date is recent */
    AND (w.start_date is NULL OR (w.start_date BETWEEN DATEADD(month, -3, GETDATE()) AND GETDATE()))
    /* Window is not cancelled */
    AND (w.end_date IS NULL OR w.start_date IS NULL or w.start_date <> w.end_date)
    /* Do not include ignored reps */
    AND w.k_brk_broker not in (
      SELECT ignore.k_brk_broker
      FROM tag_ignored_reps ignore
    )
    <cfif cid EQ 5>
      /* For Scan, eliminate Medi-Cal enrollments for external contracts */
      AND 
        (w.k_org_lob <> 7 OR 
        (w.k_org_lob = 7 
          AND w.k_BRK_entity_contract 
          NOT IN (148, 171, 142, 160, 145, 146, 210, 193, 192, 149, 143)
        ))
      /* For Scan, eliminate Miscellaneous contract */
      AND w.k_BRK_entity_contract <> 164
    </cfif>
</cfquery>

<!--- WGG 6/21/2014 populates data issues for blank line items for any windows which generated
    transactions in the last two months--->
<cfquery name="q_pop_blank_line_item_trans" datasource="#application.sys_ds#">
  INSERT INTO TAG_data_issues
    (cid
    ,k_tag_issue_type
    ,k_tag_issue_reason
    ,is_ignored
    ,date_opened
    ,is_resolved
    ,k_brk_broker
    ,k_mem_member_master
    ,k_mem_membership_window
    ,k_brk_entity_contract
    ,k_tag_issue_status_id)
  
  SELECT
     w.cid -- cid
    ,1 -- issues type: missing line item
    ,1 -- reason not known
    ,0 -- not ignored
    ,GETDATE() -- date opened
    ,0 -- is resolved
    ,w.k_brk_broker
    ,w.k_mem_member_master
    ,w.pk_mem_membership_window
    ,w.k_brk_entity_contract
    ,0 -- issue status is needs review
  
  FROM mem_membership_window w
    LEFT JOIN TAG_data_issues
      ON TAG_data_issues.k_mem_membership_window = w.pk_mem_membership_window
      AND TAG_data_issues.k_tag_issue_type = 1
    LEFT JOIN brk_broker b
      ON w.k_brk_broker = b.pk_brk_broker
    
  WHERE 1=1
    /* do not insert missing line item issues already in data issue table */
    AND TAG_data_issues.pk_TAG_data_issues IS NULL
    /* client is Molina */
    AND w.cid = <cfqueryparam value="#cid#" cfsqltype="cf_sql_integer">
    /* Line item is not assigned */
    AND w.K_BRK_entity_contract_line_item is NULL
    /* Window is not cancelled */
    AND (w.end_date IS NULL OR w.start_date IS NULL or w.start_date <> w.end_date)
    /* Do not include ignored reps */
    AND w.k_brk_broker not in (
      SELECT ignore.k_brk_broker
      FROM tag_ignored_reps ignore
    )
    AND EXISTS ( SELECT k_mem_membership_window FROM brk_Commission_transaction
      INNER JOIN brk_entity_contract_payment_period 
        ON k_brk_entity_contract_payment_period = pk_brk_entity_contract_payment_period
      WHERE k_mem_membership_window = w.pk_mem_membership_window
        AND payment_period >= DATEADD(month, -2, GETDATE()))
    <cfif cid EQ 5>
      /* For Scan, eliminate Medi-Cal enrollments for external contracts */
      AND 
        (w.k_org_lob <> 7 OR 
        (w.k_org_lob = 7 
          AND w.k_BRK_entity_contract 
          NOT IN (148, 171, 142, 160, 145, 146, 210, 193, 192, 149, 143)
        ))
      /* For Scan, eliminate Miscellaneous contract */
      AND w.k_BRK_entity_contract <> 164
    </cfif>
</cfquery>



<cfquery name="q_resolve_line_item" datasource="#application.sys_ds#">
  /* Resolve Missing Line Item Issues */
  UPDATE tdi
  SET tdi.is_resolved = 1
  FROM tag_data_issues tdi
    INNER JOIN mem_membership_window w2
      ON w2.pk_mem_membership_window = tdi.k_mem_membership_window
      WHERE tdi.cid = <cfqueryparam value="#cid#" cfsqltype="cf_sql_integer">
      and w2.K_BRK_entity_contract_line_item is NOT NULL
</cfquery>


<cfquery name="q_populate_no_agency" datasource="#application.sys_ds#">

  /* Populating data issues where enrolling rep has no agency */
  
  
  INSERT INTO TAG_data_issues
    (cid
    ,k_tag_issue_type
    ,k_tag_issue_reason
    ,is_ignored
    ,date_opened
    ,is_resolved
    ,k_brk_broker
    ,k_mem_member_master
    ,k_mem_membership_window
    ,k_brk_entity_contract
    ,k_tag_issue_status_id)
  
  SELECT
     w.cid -- cid
    ,2 -- issues type: brokeer has no agency
    ,1 -- reason not known
    ,0 -- not ignored
    ,GETDATE() -- date opened
    ,0 -- is resolved
    ,w.k_brk_broker
    ,w.k_mem_member_master
    ,w.pk_mem_membership_window
    ,w.k_brk_entity_contract
    ,0 -- issue status is needs review
  FROM mem_membership_window w
    LEFT JOIN TAG_data_issues
      ON TAG_data_issues.k_mem_membership_window = w.pk_mem_membership_window
      AND TAG_data_issues.k_tag_issue_type = 1
    LEFT JOIN brk_broker b
      ON w.k_brk_broker = b.pk_brk_broker
    LEFT JOIN BRK_broker__brk_agency_JOIN baj
      ON b.pk_brk_broker = baj.k_brk_broker
    INNER JOIN mem_member_master m
      ON m.pk_mem_member_master = w.k_mem_member_master
    
  WHERE 1=1
    /* do not insert missing line item issues already in data issue table */
    AND TAG_data_issues.pk_TAG_data_issues IS NULL
    /* client is Molina */
    AND w.cid = <cfqueryparam value="#cid#" cfsqltype="cf_sql_integer">
    /* Window start date is recent */
    AND (w.start_date is NULL OR (w.start_date BETWEEN DATEADD(month, -2, GETDATE()) AND GETDATE()))
    /* Window is not cancelled */
    AND (w.end_date IS NULL OR w.start_date IS NULL or w.start_date <> w.end_date)
    /* Do not include ignored reps */
    AND w.k_brk_broker not in (
      SELECT ignore.k_brk_broker
      FROM tag_ignored_reps ignore
    )
    <cfif cid EQ 7>
      /* the below needs to be modified per client */
      AND b.k_brk_broker_type = '3954'
    </cfif>
    AND w.k_brk_broker is not NULL
    AND baj.k_brk_broker is NULL
</cfquery>



<cfoutput>
  data_issue_queries.htm ran for cid #cid#<br>
</cfoutput>