<cfinclude template = "../cf_includes/cf_PRE_template_include.htm">
<cfparam name = "display_mode" default = "">
<!--- set form and list files --->
<cfset form_name="data_issue_report.htm">
<cfset list_file="data_issue_report.htm">
<!--- page title --->
<cfset page_title="Data Issue Report">
<!--- page header --->
<cfinclude template = "../templates/header.htm">

<!---
<cfinclude template = "data_issue_queries.htm">
--->

<!--- WGG 5/27/2014 this is if you are passing in variables
  everything which is being chosen on the report like
  dates or broker id --->
<cfset default_query_name = "">
<cfset default_variables = "
  member_id
  k_data_source
  form_ticket_status
  form_ticket_ignored
  form_broker_name
  form_broker_id
  form_mem_id
  form_ticket_resolved
  form_ticket_type
  form_ticket_reason
  ">
<!--- WGG 5/27/2014 the below line makes the cfset default_variables work --->
<cfinclude template="../cf_includes/set_defaults.htm">

<!--- WGG 6/12/2014 show only not-ignored rows on page load --->
<cfif not isdefined('form.form_ticket_ignored')>
  <cfset form.form_ticket_ignored = 0>
</cfif>


<cfif isdefined('pkid')>
  
  <cfquery name="sel_mem_id" datasource="#application.sys_ds#">
    SELECT member_id
    FROM mem_member_master
    where pk_mem_member_master = <cfqueryparam value="#pkid#" cfsqltype="cf_sql_integer">
  </cfquery>


<cfset form_mem_id = #sel_mem_id.member_id#>
<cfset form.form_mem_id = #sel_mem_id.member_id#>

</cfif>


<!--- WGG 6/12/2014 show only not-reviewed rows on page load --->
<!---
<cfif not isdefined('form.form_ticket_status')>
  <cfset form.form_ticket_status = 0>
</cfif>
--->



<!--- WGG 6/6/2014 AJAX!! --->
<script>
  
function Clear_Status() {
  $("#form_ticket_status").val(-1);
}

function Clear_Ignored() {
  $("#form_ticket_ignore").val(-1);
}

function Clear_Resolved() {
  $("#form_ticket_resolved").val(-1);
}

function Clear_Type() {
  $("#form_ticket_type").val(-1);
}

function Clear_Reason() {
  $("#form_ticket_reason").val(-1);
}

function Clear_Name() {
  $("#form_broker_name").val("");
}   

function Clear_Mem() {
  $("#form_mem_id").val("");
}  
  
 function Click_Refresh() {
     $.ajax({
            type: "POST",
            url: "data_issue_queries.htm",
            success: function(){
              //alert('hi'); 
              location.reload(); 
          }
        })
}  
  
function SaveStatus(x,y) {
  //alert(x+' '+y);
     $.ajax({
            type: "POST",
            url: "data_issue_status.htm",
            data: { id:y , sID: x},
            success: function(){
          //alert('hi'); 
        }
        })
}

function IgnoreStatus(x,y) {
  //alert(x+' '+y);
     $.ajax({
            type: "POST",
            url: "data_issue_ignore.htm",
            data: { id:y , sID: x},
            success: function(){
          //alert('hi'); 
        }
        })
}
</script> 
<!--- WGG 5/30/2014 update the status of the issue 
  <cfif isdefined('form.status_box')>
  <cfloop list="#form.status_box#" index="name">
  <cfset status = listFirst(name, "_")>
  <cfset pk = listRest(name, "_")>
  <!--- WGG 6/2/2014 comment back in to see strings 
  <cfoutput>pk=#pk# - status=#status#<br></cfoutput> 
  --->
<cfquery name="q_update_status" datasource="#application.sys_ds#">
      UPDATE TAG_data_issues
      SET TAG_data_issues.k_TAG_issue_status = #status#
      WHERE TAG_data_issues.pk_TAG_data_issues = #pk#
    </cfquery>
</cfloop> </cfif> ---> 
<!--- WGG 6/1/2014 update if the issue is ignored 
  <cfif isdefined('form.is_ignored_box')>
  <cfloop list="#form.is_ignored_box#" index="name">
  <cfset ignore = listFirst(name, "_")>
  <cfset pk = listRest(name, "_")>
  <!--- WGG 6/2/2014
  <cfoutput>pk=#pk# - ignore=#ignore#<br></cfoutput>
  --->
<cfquery name="q_update_ignore" datasource="#application.sys_ds#">
      UPDATE TAG_data_issues
      SET TAG_data_issues.is_ignored = #ignore#
      WHERE TAG_data_issues.pk_TAG_data_issues = #pk#
    </cfquery>
</cfloop> </cfif> ---> 
<!--- WGG 6/1/2014 Query to populate page --->
<cfquery name="q_data_issues" datasource="#application.sys_ds#">
  SELECT issue.pk_TAG_data_issues
    ,issue.k_TAG_issue_status
    ,s.issue_status_name
        ,issue.cid
        ,issue.k_tag_issue_type
        ,itype.issue_type_name
        ,issue.k_tag_issue_reason
        ,ireason.issue_reason_name
        ,issue.is_ignored
        ,CASE issue.is_ignored
            WHEN 0 THEN 'Not Ignored'
            WHEN 1 THEN 'Ignored'
            END
            AS is_ignored_word
        ,issue.date_opened
        ,issue.date_closed
        ,issue.date_ignored
        ,issue.is_resolved
        ,CASE issue.is_resolved
            WHEN 0 THEN 'Not Resolved'
            WHEN 1 THEN 'Resolved'
            END
            AS is_resolved_word
        ,issue.date_resolved
        ,issue.k_brk_broker
        ,issue.k_mem_member_master
        ,m.member_id
    ,m.pk_mem_member_master
        ,issue.k_mem_membership_window
        ,issue.k_brk_entity_contract
        ,b.broker_id
        ,b.name AS broker_name
        ,c.name
    ,issue.k_tag_issue_status_id
  ,o.name as lob_name
    FROM dbo.TAG_data_issues issue
      LEFT JOIN TAG_issue_type itype
          on issue.k_TAG_issue_type = itype.pk_TAG_issue_type
      LEFT JOIN TAG_issue_reason ireason
          on issue.k_TAG_issue_reason = ireason.pk_TAG_issue_reason
      LEFT JOIN mem_member_master m
          on issue.k_mem_member_master = m.pk_mem_member_master
      LEFT JOIN brk_broker b
          on issue.k_brk_broker = b.pk_brk_broker
      LEFT JOIN brk_entity_contract c
          on issue.k_brk_entity_contract = c.pk_brk_entity_contract
      LEFT JOIN tag_issue_status s
          on issue.k_tag_issue_status = s.pk_tag_issue_status
    LEFT JOIN mem_membership_window w
      on w.pk_mem_membership_window = issue.k_mem_membership_window
    INNER JOIN org_lob o
      on w.k_org_lob = o.pk_org_lob
  WHERE 1=1

    <cfif isdefined('form.form_ticket_status')>
      AND k_tag_issue_status_id IN (<cfqueryparam value="#form_ticket_status#" cfsqltype="cf_sql_integer" list="true"/>)
    </cfif> 

    <cfif isdefined('form.form_ticket_ignored') AND len('form.form_ticket_ignored')>
      AND is_ignored IN (<cfqueryparam value="#form.form_ticket_ignored#" cfsqltype="cf_sql_integer" list="true"/>)
    </cfif> 
  
    <cfif isdefined('form.form_ticket_resolved') AND len('form.form_ticket_resolved')>
      AND is_resolved IN (<cfqueryparam value="#form.form_ticket_resolved#" cfsqltype="cf_sql_integer" list="true"/>)
    </cfif>   

  <cfif isdefined('form.form_ticket_type') AND len('form.form_ticket_type')>
    AND k_tag_issue_type IN (<cfqueryparam value="#form.form_ticket_type#" cfsqltype="cf_sql_integer" list="true"/>)
  </cfif> 
  
  <cfif isdefined('form.form_ticket_reason') AND len('form.form_ticket_reason')>
    AND k_tag_issue_reason IN (<cfqueryparam value="#form.form_ticket_reason#" cfsqltype="cf_sql_integer" list="true"/>)
  </cfif> 

    <cfif isdefined('form.form_broker_name')>
      AND b.name LIKE (<cfqueryparam value="%#form_broker_name#%" cfsqltype="cf_sql_varchar"/>)
    </cfif> 
  
  <cfif isdefined('form.form_mem_id')>
      AND m.member_id LIKE (<cfqueryparam value="%#form_mem_id#%" cfsqltype="cf_sql_varchar"/>)
    </cfif> 
  ORDER BY issue.is_ignored, issue.k_TAG_issue_status, issue.k_tag_issue_type, issue.k_tag_issue_reason, issue.k_brk_broker

</cfquery>
<cfquery name="q_sel_status" datasource="#application.sys_ds#">
  SELECT *
  FROM tag_issue_status
</cfquery>
<cfquery name="q_sel_ignored" datasource="#application.sys_ds#">
  SELECT 
    ignored =  --ignored is the alias
      CASE is_ignored
        WHEN 1  THEN 'Ignored'
        WHEN 0 THEN 'Not Ignored'
        ELSE 'Unknown'

        END
    ,is_ignored
  FROM tag_data_issues
  GROUP BY is_ignored
</cfquery>

<cfquery name="q_sel_resolved" datasource="#application.sys_ds#">
  SELECT 
    resolved =  --resolved is the alias
      CASE is_resolved
        WHEN 1  THEN 'Resolved'
        WHEN 0 THEN 'Not Resolved'
        ELSE 'Unknown'

        END
    ,is_resolved
  FROM tag_data_issues
  GROUP BY is_resolved
</cfquery>

<cfquery name="q_sel_type" datasource="#application.sys_ds#">
  SELECT 
    type =  --type is the alias
      CASE k_tag_issue_type
        WHEN 1  THEN 'No Line Item'
        WHEN 2 THEN 'Broker has no Agency'
    WHEN 3 THEN 'App rec outside Agency dates'
        ELSE 'Unknown'

        END
    ,k_tag_issue_type
  FROM tag_data_issues
  GROUP BY k_tag_issue_type
</cfquery>


<cfquery name="q_sel_reason" datasource="#application.sys_ds#">
  SELECT 
  reason =  --reason is the alias
    CASE k_tag_issue_reason
          WHEN 1  THEN 'Unknown'
          WHEN 2 THEN 'No Broker Contract'
      WHEN 3 THEN 'App Rec Outside Contract'
      WHEN 4 THEN 'No Universal Contract'
      WHEN 5 THEN 'No Agency'
      WHEN 6 THEN 'App Rec Outside Agency'
          ELSE 'Unknown'
    END
  ,k_tag_issue_reason
  FROM tag_data_issues
  GROUP BY k_tag_issue_reason
</cfquery>

  <!--- ############################################################################
  ################################# Data Issue Search ##############################
  ##################################################################################--->
  
<!--- WGG 6/1/2014 Display issues on page --->
<cfform method="POST" action="data_issue_report.htm" name="test">
  <div style="border-style:solid; border-width: 1px; border-radius:15px; width:100%;
    margin: 0 auto 0 auto; padding: 10px; background:#FFFFFF;">
    <div align="center">
      <span>
        <b>
          Data Issue Search
        </b>
      </span>
  
      <table id="cpy" class="list_table scrolling" scroll_height="700" width="100%">
        <tr class="list_col_hdr">
          <td align="center">
            Status
          </td>
          <td align="center">
            Ignored
          </td>
    
          <td align="center">
            Resolved
          </td>

          <td align="center">
            Issue Type
          </td>
              
          <td align="center">
            Issue Reason
          </td>
    
      <td align="center">
      Rep Name
          </td>
    
      <td align="center">
      Member ID
          </td>
          
          <td rowspan="2" width="150" align="center">
            <input class="form_submit_button" type="submit" value="Search" name="Submit">
      <br><br>
      <button type="button" id="RefreshButton" onclick="Click_Refresh()">Refresh</button>
          </td>
        </tr>
        <tr class="list_even_odd">
          <td align="center">
            <cfselect query="q_sel_status" 
              id="form_ticket_status"
              value="issue_status_id" 
              display="issue_status_name" 
              name="form_ticket_status" 
              selected="#form_ticket_status#" 
              multiple="yes" 
              size="3">
            </cfselect><br><br>
            <button type="button" id="StatusSub" onclick="Clear_Status()">
              Clear
            </button>
          </td>
    
          <td align="center">
            <cfselect query="q_sel_ignored" 
              id="form_ticket_ignore"
              value="is_ignored" 
              display="ignored" 
              name="form_ticket_ignored" 
              selected="#form_ticket_ignored#" 
              multiple="yes" 
              size="3">
            </cfselect><br><br>
            <button type="button" id="StatusSub" onclick="Clear_Ignored()">
              Clear
            </button>
          </td>
    
          <td align="center">
            <cfselect query="q_sel_resolved" 
              id="form_ticket_resolved"
              value="is_resolved" 
              display="resolved" 
              name="form_ticket_resolved" 
              selected="#form_ticket_resolved#" 
              multiple="yes" 
              size="3">
            </cfselect><br><br>
            <button type="button" id="StatusSub" onclick="Clear_Resolved()">
              Clear
            </button>
          </td>

    <!--- WGG 6/25/2014 Issue Type --->
          <td align="center">
            <cfselect query="q_sel_type" 
              id="form_ticket_type"
              value="k_tag_issue_type" 
              display="type" 
              name="form_ticket_type" 
              selected="#form_ticket_type#" 
              multiple="yes" 
              size="3">
            </cfselect><br><br>
            <button type="button" id="StatusSub" onclick="Clear_Type()">
              Clear
            </button>
          </td>
    
    <!--- WGG 6/25/2014 Issue Reason --->
          <td align="center">
            <cfselect query="q_sel_reason" 
              id="form_ticket_reason"
              value="k_tag_issue_reason" 
              display="reason" 
              name="form_ticket_reason" 
              selected="#form_ticket_reason#" 
              multiple="yes" 
              size="3">
            </cfselect><br><br>
            <button type="button" id="StatusSub" onclick="Clear_Reason()">
              Clear
            </button>
          </td>
    
          <td align="center" style="vertical-align:middle;">
            <cfoutput><input type="text" id="form_broker_name" name="form_broker_name" size="15" value="#form_broker_name#"></cfoutput>
            <br>
            <br>
            <br>
            <button type="button" id="StatusSub" onclick="Clear_Name()">
              Clear
            </button>
          </td>

          <td align="center" style="vertical-align:middle;">
            <cfoutput><input type="text" id="form_mem_id" name="form_mem_id" size="15" value="#form_mem_id#"></cfoutput>
            <br>
            <br>
            <br>
            <button type="button" id="StatusSub" onclick="Clear_Mem()">
              Clear
            </button>
          </td> 
    
        </tr>
      </table>
    </div>
  </div>
  <br>
<!---
################################################################
############## Data Issues Table ##########################
################################################################
--->
  <div style="border-style:solid; border-width: 1px; border-radius:15px; width:100%;
    margin: 0 auto 0 auto; padding: 10px; background:#FFFFFF;">
    <div align="center">
      <span>
        <b>
          Data Issues
        </b>
      </span>
      <table id="cpy" class="list_table scrolling" scroll_height="1500" width=100%>
          <tr class="list_col_hdr">
            <td align="center">
              Status
            </td>
            <!--- WGG 0 --->
            <td align="center">
              Ignored
            </td>
            <!--- WGG 3 --->
            <td align="center">
              Resolved
            </td>
            <!--- WGG 3 --->
      <td align="center">
        Issue Type
        <br>
        Reason
            </td>
            <!--- WGG 2 --->
            <td align="center">
              Date Opened
            </td>
      <!--- WGG
            <!--- WGG 4 --->
            <td align="center">
              Date Resolved
            </td>
            <!--- WGG 5 --->
            <td align="center">
              Date Ignored
            </td>
      --->
            <!--- WGG 6 --->
            <td align="center">
              Rep ID
              <br>
              Rep Name
            </td>
            <!--- WGG 7 --->
            <td align="center">
              Contract ID
              <br>
              Contract Name
        <br>
        Line of Business
            </td>
            <!--- WGG 10 --->
            <td align="center">
              Member ID
            </td>
            <!--- WGG 11 --->
          </tr>
        <cfset toggle = 1>
        <cfoutput query = "q_data_issues">
          <cfif toggle gt 0>
            <cfset even_odd = "even">
          <cfelse>
            <cfset even_odd = "odd">
          </cfif>
          <cfset toggle = toggle*-1>
          <tr class="list_even_odd">
            <td align="center" >
              <!--- WGG 0 --->
              <select name="status_box" id="status_box" onChange="SaveStatus(this.value,#pk_TAG_data_issues#)">
              <option value="0" 
              <cfif k_tag_issue_status_id eq '0'>
                Selected="selected"
              </cfif>
              >Not Reviewed</option> <option value="1" 
              <cfif k_tag_issue_status_id eq '1'>
                Selected="selected"
              </cfif>
              >Awaiting Calc</option> 
            </td>
            <td align="center" >
              <!--- WGG 3 --->
              <select name="is_ignored_box" id="is_ignored_box" onChange="IgnoreStatus(this.value,#pk_TAG_data_issues#)">
              <option value="0" 
              <cfif is_ignored eq '0'>
                Selected="selected"
              </cfif>
              >Not Ignored</option> <option value="1" 
              <cfif is_ignored eq '1'>
                Selected="selected"
              </cfif>
              >Ignored</option> 
            </td>
            <td align="center">
              #is_resolved_word#
            </td>
      <td align="center">
        #issue_type_name#
        <br>
        #issue_reason_name#
            </td>
            <!--- WGG 2 --->
            <td align="center">
              #dateformat(date_opened,"medium")#
            </td>
      <!--- WGG hiding resolved and ignored dates
            <!--- WGG 4 --->
            <td align="center">
              #date_closed#
            </td>
            <!--- WGG 5 --->
            <td align="center">
              #date_ignored#
            </td>
      --->
            <!--- WGG 6 --->
            <td align="center">
              <a href="../call_center_sales/list_brokers.htm?brkid=#k_brk_broker#">
                #broker_id#
              </a>
              <br>
              #broker_name#
            </td>
            <!--- WGG 8 --->
            <td align="center">
              #k_brk_entity_contract#
              <br>
              #name#
        <br>
        #lob_name#
            </td>
            <!--- WGG 10 --->
            <td align="center">
              <a href="../members/list_member.htm?memid=#pk_mem_member_master#">
                #member_id#
              </a>
            </td>
            <!--- WGG 11 --->
            <!--- https://molina.sb.evolvespm.com/members/list_member.htm?memid=1310773 --->
          </tr>
        </cfoutput>
      </table>
      <br>
      <input class="form_submit_button" type="submit" value="Submit" name="Submit">
    </div>
  </div>
  <br>
</cfform>
<cfset ajaxonload("doScrollTables")>
<!--- <cfset ajaxonload("makeSortable")> --->
