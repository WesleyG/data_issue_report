<cfinclude template = "../cf_includes/cf_PRE_template_include.htm">
<cfparam name = "display_mode" default = "">

<!--- set form and list files --->
<cfset form_name="data_issue_report.htm">
<cfset list_file="data_issue_report.htm">

<!--- page title --->
<cfset page_title="Data Issue Report">

<!--- page header --->
<cfinclude template = "../templates/header.htm">

<!--- WGG 5/27/2014 this is if you are passing in variables
      everything which is being chosen on the report like
      dates or broker id --->
<cfset default_query_name = "">
<cfset default_variables = "
member_id
k_data_source
form_ticket_status
">
<!--- WGG 5/27/2014 the below line makes the cfset default_variables work --->
<cfinclude template="../cf_includes/set_defaults.htm">

<!--- WGG 6/6/2014 AJAX!! --->
<script>
function SaveStatus(x,y) {
  //alert(x+' '+y);
     $.ajax({
            type: "POST",
            url: "data_issue_status.htm",
            data: { id:y , sID: x},
            success: function(){
          //alert('hi'); 
        }
        })
}

function IgnoreStatus(x,y) {
  //alert(x+' '+y);
     $.ajax({
            type: "POST",
            url: "data_issue_ignore.htm",
            data: { id:y , sID: x},
            success: function(){
          //alert('hi'); 
        }
        })
}
</script>

<!--- WGG 5/30/2014 update the status of the issue 
<cfif isdefined('form.status_box')>
    <cfloop list="#form.status_box#" index="name">
     <cfset status = listFirst(name, "_")>
     <cfset pk = listRest(name, "_")>
     <!--- WGG 6/2/2014 comment back in to see strings 
   <cfoutput>pk=#pk# - status=#status#<br></cfoutput> 
   --->
  
    <cfquery name="q_update_status" datasource="#application.sys_ds#">
      UPDATE TAG_data_issues
      SET TAG_data_issues.k_TAG_issue_status = #status#
      WHERE TAG_data_issues.pk_TAG_data_issues = #pk#
    </cfquery>
    
    </cfloop>
</cfif>
--->

<!--- WGG 6/1/2014 update if the issue is ignored 
<cfif isdefined('form.is_ignored_box')>
    <cfloop list="#form.is_ignored_box#" index="name">
     <cfset ignore = listFirst(name, "_")>
     <cfset pk = listRest(name, "_")>
  <!--- WGG 6/2/2014
     <cfoutput>pk=#pk# - ignore=#ignore#<br></cfoutput>
  --->
    <cfquery name="q_update_ignore" datasource="#application.sys_ds#">
      UPDATE TAG_data_issues
      SET TAG_data_issues.is_ignored = #ignore#
      WHERE TAG_data_issues.pk_TAG_data_issues = #pk#
    </cfquery>
    
    </cfloop>
</cfif>
--->

<!--- WGG 6/1/2014 Query to populate page --->
<cfquery name="q_data_issues" datasource="#application.sys_ds#">
  SELECT issue.pk_TAG_data_issues
    ,issue.k_TAG_issue_status
    ,s.issue_status_name
        ,issue.cid
        ,issue.k_tag_issue_type
        ,itype.issue_type_name
        ,issue.k_tag_issue_reason
        ,ireason.issue_reason_name
        ,issue.is_ignored
        ,CASE issue.is_ignored
            WHEN 0 THEN 'Not Ignored'
            WHEN 1 THEN 'Ignored'
            END
            AS is_ignored_word
        ,issue.date_opened
        ,issue.date_closed
        ,issue.date_ignored
        ,issue.is_resolved
        ,CASE issue.is_resolved
            WHEN 0 THEN 'Not Resolved'
            WHEN 1 THEN 'Resolved'
            END
            AS is_resolved_word
        ,issue.date_resolved
        ,issue.k_brk_broker
        ,issue.k_mem_member_master
        ,m.member_id
    ,m.pk_mem_member_master
        ,issue.k_mem_membership_window
        ,issue.k_brk_entity_contract
        ,b.broker_id
        ,b.name AS broker_name
        ,c.name
    FROM dbo.TAG_data_issues issue
      LEFT JOIN TAG_issue_type itype
          on issue.k_TAG_issue_type = itype.pk_TAG_issue_type
      LEFT JOIN TAG_issue_reason ireason
          on issue.k_TAG_issue_reason = ireason.pk_TAG_issue_reason
      LEFT JOIN mem_member_master m
          on issue.k_mem_member_master = m.pk_mem_member_master
      LEFT JOIN brk_broker b
          on issue.k_brk_broker = b.pk_brk_broker
      LEFT JOIN brk_entity_contract c
          on issue.k_brk_entity_contract = c.pk_brk_entity_contract
    LEFT JOIN tag_issue_status s
      on issue.k_tag_issue_status = s.pk_tag_issue_status
  WHERE 1=1
    <cfif isdefined('form.form_ticket_status')>
      AND k_tag_issue_status IN (<cfqueryparam value="#form_ticket_status#" cfsqltype="cf_sql_integer" list="true"/>)
    </cfif> 
  ORDER BY issue.is_ignored, issue.k_TAG_issue_status, issue.k_tag_issue_type, issue.k_tag_issue_reason, issue.k_brk_broker
    
</cfquery>

<cfquery name="q_sel_status" datasource="#application.sys_ds#">
  SELECT *
  FROM tag_issue_status
</cfquery>

<!--- WGG 6/1/2014 Display issues on page --->
<cfform method="POST" action="data_issue_report.htm" name="test">    
    <table id="cpy" class="list_table scrolling" scroll_height="700" width="1400">
  
      <tr class="list_col_hdr">
        
        <td align="center">Status</td>
        <td align="center">Type</td>
        <td rowspan="2" width="150" align="center"><input class="form_submit_button" type="submit" value="Search" name="Submit"></td>
      </tr>

      <tr class="list_even_odd">
        
        
        <td align="center"><cfselect query="q_sel_status" 
                  id="form_ticket_status"
                  value="pk_tag_issue_status" 
                  display="issue_status_name" 
                  name="form_ticket_status" 
                  selected="#form_ticket_status#" 
                  multiple="yes" 
                  size="3"
                  style="width:150px;"></cfselect>
          <button type="button" id="StatusSub" onclick="Status_Submitted()">Clear</button>  
        </td>
      </tr>
    </table><br>
    
  <div style="border-style:solid; border-width: 1px; border-radius:15px; width:1500;
              margin: 0 auto 0 auto; padding: 10px; background:#FFFFFF;">
      <div align="center">
      <span><b>Data Issues</b></span>
      <table id="cpy" class="list_table scrolling" scroll_height="1500" width="1450">
          <thead>
          <tr class="list_col_hdr">
        <td align="center">Status</td><!--- WGG 0 --->
              <td align="center">Ignored</td><!--- WGG 3 --->
              <td align="center">Resolved</td><!--- WGG 3 --->      
              <td align="center">Issue Type</td><!--- WGG 1 --->
              <td align="center">Reason</td><!--- WGG 2 --->      
              <td align="center">Date Opened</td><!--- WGG 4 --->
              <td align="center">Date Resolved</td><!--- WGG 5 --->
              <td align="center">Date Ignored</td><!--- WGG 6 --->
              <td align="center">Rep ID<br>Rep Name</td><!--- WGG 7 --->
              <td align="center">Contract ID<br>Contract Name</td><!--- WGG 10 --->
              <td align="center">Member ID</td><!--- WGG 11 --->
          </tr>
          </thead>
          <cfset toggle = 1>
          <cfoutput query = "q_data_issues">
          <cfif toggle gt 0><cfset even_odd = "even"><cfelse><cfset even_odd = "odd"></cfif><cfset toggle = toggle*-1>
          <tr class="list_even_odd">
              <td align="center" ><!--- WGG 0 --->
                  <select name="status_box" id="status_box" onChange="SaveStatus(this.value,#pk_TAG_data_issues#)">
                  <option value="0" <cfif k_TAG_issue_status eq '0'>Selected="selected"</cfif>>Not Reviewed</option>
                  <option value="1" <cfif k_TAG_issue_status eq '1'>Selected="selected"</cfif>>Awaiting Calc</option>    
              </td>
              <td align="center" ><!--- WGG 3 --->
                  <select name="is_ignored_box" id="is_ignored_box" onChange="IgnoreStatus(this.value,#pk_TAG_data_issues#)">
                  <option value="1" <cfif is_ignored eq '1'>Selected="selected"</cfif>>Not Ignored</option>
                  <option value="2" <cfif is_ignored eq '2'>Selected="selected"</cfif>>Ignored</option>    
              </td>
              <td align="center">#is_resolved_word#</td><!--- WGG 2 --->
        <td align="center">#issue_type_name#</td><!--- WGG 1 --->
              <td align="center">#issue_reason_name#</td><!--- WGG 2 --->
              <td align="center">#dateformat(date_opened,"medium")#</td><!--- WGG 4 --->
              <td align="center">#date_closed#</td><!--- WGG 5 --->
              <td align="center">#date_ignored#</td><!--- WGG 6 --->
              <td align="center"><a href="../call_center_sales/list_brokers.htm?brkid=#k_brk_broker#">#broker_id#</a><br>#broker_name#</td><!--- WGG 8 ---> 
                     
              <td align="center">#k_brk_entity_contract#<br>#name#</td><!--- WGG 10 --->
              <td align="center"><a href="../members/list_member.htm?memid=#pk_mem_member_master#">#member_id#</a></td><!--- WGG 11 --->
        <!--- https://molina.sb.evolvespm.com/members/list_member.htm?memid=1310773 --->
      
          </tr>
          </cfoutput>      
      </table>
     <br>
     <input class="form_submit_button" type="submit" value="Submit" name="Submit">
      </div>
  </div>
  <br>
</cfform>

<cfset ajaxonload("doScrollTables")>
<cfset ajaxonload("makeSortable")>